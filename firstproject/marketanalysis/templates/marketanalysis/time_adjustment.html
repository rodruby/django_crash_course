{% extends "marketanalysis/base.html" %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="{% url 'marketanalysis:view_analysis' upload.pk %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Analysis
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-lg">
    <!-- Analysis Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="bi bi-info-circle"></i> Time Adjustment Analysis
                </h6>
                <p class="mb-0">
                    Calculate market-based time adjustments for comparable sales relative to an effective appraisal date.
                    The system will use multiple methodologies including monthly median data and trendline analysis.
                </p>
            </div>
        </div>
    </div>

    <!-- Time Adjustment Form -->
    <form method="post" id="timeAdjustmentForm">
        {% csrf_token %}

        <!-- Effective Date Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calendar-check"></i> Effective Date
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="{{ form.effective_date.id_for_label }}" class="form-label">
                                    {{ form.effective_date.label }}
                                </label>
                                {{ form.effective_date }}
                                {% if form.effective_date.help_text %}
                                <div class="form-text">{{ form.effective_date.help_text }}</div>
                                {% endif %}
                                {% if form.effective_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.effective_date.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparable Sales Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-houses"></i> Comparable Sales
                        </h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="addComparable">
                            <i class="bi bi-plus"></i> Add Comparable
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="comparableFormsContainer">
                            {{ formset.management_form }}

                            {% for form in formset %}
                            <div class="comparable-form-row" data-form-index="{{ forloop.counter0 }}">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">Comparable Sale #<span class="comparable-number">{{ forloop.counter }}</span></h6>
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-comparable">
                                                <i class="bi bi-trash"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Sale Date -->
                                    <div class="col-md-3">
                                        <label for="{{ form.sale_date.id_for_label }}" class="form-label">
                                            {{ form.sale_date.label }}
                                        </label>
                                        {{ form.sale_date }}
                                        {% if form.sale_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.sale_date.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Sale Price -->
                                    <div class="col-md-3">
                                        <label for="{{ form.sale_price.id_for_label }}" class="form-label">
                                            {{ form.sale_price.label }}
                                        </label>
                                        {{ form.sale_price }}
                                        {% if form.sale_price.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.sale_price.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Square Footage -->
                                    <div class="col-md-2">
                                        <label for="{{ form.square_footage.id_for_label }}" class="form-label">
                                            {{ form.square_footage.label }}
                                        </label>
                                        {{ form.square_footage }}
                                        {% if form.square_footage.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.square_footage.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Address -->
                                    <div class="col-md-4">
                                        <label for="{{ form.address.id_for_label }}" class="form-label">
                                            {{ form.address.label }}
                                        </label>
                                        {{ form.address }}
                                        {% if form.address.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.address.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Delete checkbox (hidden) -->
                                {% if form.DELETE %}
                                <div style="display: none;">
                                    {{ form.DELETE }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Instructions -->
                        <div class="mt-4">
                            <div class="alert alert-light">
                                <h6><i class="bi bi-lightbulb"></i> Instructions:</h6>
                                <ul class="mb-0">
                                    <li>Add comparable sales that occurred before the effective date</li>
                                    <li>Sale price and sale date are required for each comparable</li>
                                    <li>Square footage is optional but recommended for more accurate analysis</li>
                                    <li>Address is optional but helpful for record keeping</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-calculator"></i> Calculate Time Adjustments
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Empty form template for JavaScript -->
<div id="emptyFormTemplate" style="display: none;">
    <div class="comparable-form-row" data-form-index="__prefix__">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Comparable Sale #<span class="comparable-number">__number__</span></h6>
                    <button type="button" class="btn btn-sm btn-outline-danger delete-comparable">
                        <i class="bi bi-trash"></i> Remove
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Sale Date</label>
                <input type="date" name="form-__prefix__-sale_date" class="form-control" id="id_form-__prefix__-sale_date">
            </div>
            <div class="col-md-3">
                <label class="form-label">Sale Price ($)</label>
                <input type="number" name="form-__prefix__-sale_price" class="form-control" min="0" step="0.01" placeholder="500000" id="id_form-__prefix__-sale_price">
            </div>
            <div class="col-md-2">
                <label class="form-label">Living Area (sq ft)</label>
                <input type="number" name="form-__prefix__-square_footage" class="form-control" min="1" placeholder="2000" id="id_form-__prefix__-square_footage">
            </div>
            <div class="col-md-4">
                <label class="form-label">Property Address</label>
                <input type="text" name="form-__prefix__-address" class="form-control" placeholder="456 Oak Ave, City, State" id="id_form-__prefix__-address">
            </div>
        </div>

        <div style="display: none;">
            <input type="checkbox" name="form-__prefix__-DELETE" id="id_form-__prefix__-DELETE">
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('comparableFormsContainer');
    const addButton = document.getElementById('addComparable');
    const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
    const template = document.getElementById('emptyFormTemplate').innerHTML;

    // Update comparable numbers
    function updateComparableNumbers() {
        const forms = container.querySelectorAll('.comparable-form-row:not(.to-delete)');
        forms.forEach((form, index) => {
            const numberSpan = form.querySelector('.comparable-number');
            if (numberSpan) {
                numberSpan.textContent = index + 1;
            }
        });
    }

    // Add new comparable form
    addButton.addEventListener('click', function() {
        const currentFormCount = parseInt(totalFormsInput.value);
        const newFormHtml = template
            .replace(/__prefix__/g, currentFormCount)
            .replace(/__number__/g, currentFormCount + 1);

        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalFormsInput.value = currentFormCount + 1;

        // Add event listener to new delete button
        const newForm = container.lastElementChild;
        const deleteButton = newForm.querySelector('.delete-comparable');
        deleteButton.addEventListener('click', function() {
            deleteComparable(newForm);
        });

        updateComparableNumbers();
    });

    // Delete comparable form
    function deleteComparable(formRow) {
        const deleteCheckbox = formRow.querySelector('input[name$="-DELETE"]');
        if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            formRow.classList.add('to-delete');
        } else {
            formRow.remove();
        }
        updateComparableNumbers();
    }

    // Add event listeners to existing delete buttons
    document.querySelectorAll('.delete-comparable').forEach(button => {
        button.addEventListener('click', function() {
            const formRow = button.closest('.comparable-form-row');
            deleteComparable(formRow);
        });
    });

    // Form validation
    const form = document.getElementById('timeAdjustmentForm');
    form.addEventListener('submit', function(e) {
        const effectiveDate = document.getElementById('id_effective_date').value;
        const validComparables = container.querySelectorAll('.comparable-form-row:not(.to-delete)');

        if (!effectiveDate) {
            e.preventDefault();
            alert('Please select an effective date.');
            return;
        }

        if (validComparables.length === 0) {
            e.preventDefault();
            alert('Please add at least one comparable sale.');
            return;
        }

        // Check if each valid comparable has required fields
        let hasErrors = false;
        validComparables.forEach(row => {
            const saleDate = row.querySelector('input[name$="-sale_date"]').value;
            const salePrice = row.querySelector('input[name$="-sale_price"]').value;

            if (!saleDate || !salePrice) {
                hasErrors = true;
            }
        });

        if (hasErrors) {
            e.preventDefault();
            alert('Please fill in sale date and sale price for all comparables.');
            return;
        }

        // Show loading state
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Calculating...';
    });

    // Initialize comparable numbers
    updateComparableNumbers();
});
</script>
{% endblock %}